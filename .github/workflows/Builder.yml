name: ğŸ”§ ESP32 Firmware Builder (Async Edition)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§± Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Install Arduino CLI
        run: |
          wget -q https://downloads.arduino.cc/arduino-cli/arduino-cli_latest_Linux_64bit.tar.gz
          tar -xzf arduino-cli_latest_Linux_64bit.tar.gz
          sudo mv arduino-cli /usr/local/bin/
          arduino-cli version

      - name: ğŸ§© Configure Arduino CLI
        run: |
          arduino-cli config init --overwrite
          arduino-cli config set board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      - name: ğŸ“¦ Install required libraries
        run: |
          arduino-cli lib install "AsyncTCP" || true
          arduino-cli lib install "ESP Async WebServer" || true
          arduino-cli lib install "ArduinoJson" || true

      - name: ğŸ—ï¸ Compile ESP32 firmware
        run: |
          mkdir -p build
          arduino-cli compile --fqbn esp32:esp32:esp32 --output-dir build ./
          echo "âœ… Compilation successful!"

      - name: ğŸ“œ List build output
        run: ls -lh build || true

      - name: ğŸ§© Merge firmware files into single BIN
        run: |
          # Ø¯Ù…Ø¬ Ù…Ù„ÙØ§Øª Ø§Ù„ÙÙ„Ø§Ø´ ÙÙŠ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¬Ø§Ù‡Ø² Ù„Ù„ÙÙ„Ø§Ø´ Ø§Ù„ÙƒØ§Ù…Ù„
          python3 - <<'EOF'
import os
import sys
import subprocess

# ØªØ­Ø¯ÙŠØ¯ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ build
base = "build"
bootloader = None
app = None
partitions = None
boot_app0 = None

for f in os.listdir(base):
    if "bootloader" in f and f.endswith(".bin"):
        bootloader = os.path.join(base, f)
    elif f.endswith(".bin") and "bootloader" not in f and "partitions" not in f and "boot_app0" not in f:
        app = os.path.join(base, f)
    elif "partitions" in f and f.endswith(".bin"):
        partitions = os.path.join(base, f)
    elif "boot_app0" in f and f.endswith(".bin"):
        boot_app0 = os.path.join(base, f)

if not all([bootloader, app, partitions, boot_app0]):
    print("âŒ Missing required BIN files!")
    sys.exit(1)

cmd = [
    "esptool.py", "merge_bin",
    "--flash_mode", "dio",
    "--flash_freq", "40m",
    "--flash_size", "4MB",
    "0x1000", bootloader,
    "0x8000", partitions,
    "0xe000", boot_app0,
    "0x10000", app,
    os.path.join(base, "firmware_merged.bin")
]
subprocess.run(cmd, check=True)
print("âœ… Created merged binary: firmware_merged.bin")
EOF

      - name: ğŸ“¦ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32-firmware
          path: build

      - name: âœ… Summary
        run: |
          echo "ğŸ‰ Build finished successfully!"
          echo "ğŸ“ Download artifacts from the Actions tab."
